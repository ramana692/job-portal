<!DOCTYPE html>
<html>
<head>
    <title>MongoDB Test - Job Application</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; }
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .output { background: #f4f4f4; padding: 15px; margin-top: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .error { color: red; }
        .success { color: green; }
        input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        h1 { color: #333; }
        h2 { color: #666; font-size: 18px; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üß™ MongoDB Connection Test</h1>
    <div id="statusBar" class="status"></div>
    
    <div class="section">
        <h2>1Ô∏è‚É£ Test Backend Connection</h2>
        <button onclick="testBackend()">Test Backend</button>
        <div id="backendOutput" class="output"></div>
    </div>

    <div class="section">
        <h2>2Ô∏è‚É£ Signup New User</h2>
        <input type="text" id="signupName" placeholder="Name" value="Test User">
        <input type="email" id="signupEmail" placeholder="Email" value="test@example.com">
        <input type="password" id="signupPassword" placeholder="Password" value="test123">
        <input type="tel" id="signupPhone" placeholder="Phone" value="1234567890">
        <button onclick="testSignup()">Create Account</button>
        <div id="signupOutput" class="output"></div>
    </div>

    <div class="section">
        <h2>3Ô∏è‚É£ Login</h2>
        <input type="email" id="loginEmail" placeholder="Email" value="test@example.com">
        <input type="password" id="loginPassword" placeholder="Password" value="test123">
        <button onclick="testLogin()">Login</button>
        <div id="loginOutput" class="output"></div>
    </div>

    <div class="section">
        <h2>4Ô∏è‚É£ Submit Job Application (Must Login First)</h2>
        <p><strong>Current Token:</strong> <span id="tokenDisplay">Not logged in</span></p>
        <input type="text" id="jobTitle" placeholder="Job Title" value="Software Developer">
        <input type="text" id="company" placeholder="Company" value="Tech Corp">
        <input type="text" id="applicantName" placeholder="Your Name" value="Test User">
        <input type="email" id="applicantEmail" placeholder="Your Email" value="test@example.com">
        <input type="tel" id="applicantPhone" placeholder="Your Phone" value="1234567890">
        <textarea id="coverLetter" placeholder="Cover Letter" rows="3">I am very interested in this position...</textarea>
        <button onclick="testSubmitApplication()">Submit Application</button>
        <div id="applicationOutput" class="output"></div>
    </div>

    <div class="section">
        <h2>5Ô∏è‚É£ Get My Applications</h2>
        <button onclick="testGetApplications()">Get My Applications</button>
        <div id="getApplicationsOutput" class="output"></div>
    </div>

    <div class="section">
        <h2>6Ô∏è‚É£ Check MongoDB Directly</h2>
        <button onclick="checkMongoDB()">Check Database Count</button>
        <div id="mongoOutput" class="output"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let token = null;

        function updateStatus(connected) {
            const statusBar = document.getElementById('statusBar');
            if (connected) {
                statusBar.className = 'status connected';
                statusBar.textContent = '‚úÖ Backend Connected: http://localhost:5000';
            } else {
                statusBar.className = 'status disconnected';
                statusBar.textContent = '‚ùå Backend Disconnected - Please start backend server';
            }
        }

        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = isError ? 'output error' : 'output success';
        }

        async function testBackend() {
            try {
                const response = await fetch('http://localhost:5000/');
                const data = await response.json();
                log('backendOutput', '‚úÖ SUCCESS:\n' + JSON.stringify(data, null, 2));
                updateStatus(true);
            } catch (error) {
                log('backendOutput', '‚ùå ERROR: ' + error.message, true);
                updateStatus(false);
            }
        }

        async function testSignup() {
            try {
                const userData = {
                    name: document.getElementById('signupName').value,
                    email: document.getElementById('signupEmail').value,
                    password: document.getElementById('signupPassword').value,
                    phone: document.getElementById('signupPhone').value
                };

                console.log('Sending signup request:', userData);

                const response = await fetch(`${API_URL}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                console.log('Signup response:', data);
                
                if (response.ok) {
                    token = data.token;
                    document.getElementById('tokenDisplay').textContent = token.substring(0, 30) + '...';
                    log('signupOutput', '‚úÖ SUCCESS! User created in MongoDB:\n' + JSON.stringify(data, null, 2));
                    
                    // Pre-fill login form
                    document.getElementById('loginEmail').value = userData.email;
                    document.getElementById('loginPassword').value = userData.password;
                } else {
                    log('signupOutput', '‚ùå ERROR:\n' + JSON.stringify(data, null, 2), true);
                }
            } catch (error) {
                log('signupOutput', '‚ùå ERROR: ' + error.message, true);
            }
        }

        async function testLogin() {
            try {
                const credentials = {
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value
                };

                console.log('Sending login request:', credentials);

                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credentials)
                });

                const data = await response.json();
                console.log('Login response:', data);
                
                if (response.ok) {
                    token = data.token;
                    document.getElementById('tokenDisplay').textContent = token.substring(0, 30) + '...';
                    log('loginOutput', '‚úÖ SUCCESS! Logged in:\n' + JSON.stringify(data, null, 2));
                } else {
                    log('loginOutput', '‚ùå ERROR:\n' + JSON.stringify(data, null, 2), true);
                }
            } catch (error) {
                log('loginOutput', '‚ùå ERROR: ' + error.message, true);
            }
        }

        async function testSubmitApplication() {
            if (!token) {
                log('applicationOutput', '‚ùå ERROR: Please login first!', true);
                return;
            }

            try {
                const applicationData = {
                    jobTitle: document.getElementById('jobTitle').value,
                    company: document.getElementById('company').value,
                    applicantName: document.getElementById('applicantName').value,
                    email: document.getElementById('applicantEmail').value,
                    phone: document.getElementById('applicantPhone').value,
                    coverLetter: document.getElementById('coverLetter').value,
                    resume: "resume.pdf"
                };

                console.log('Sending application:', applicationData);
                console.log('Using token:', token);

                const response = await fetch(`${API_URL}/applications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(applicationData)
                });

                const data = await response.json();
                console.log('Application response:', data);
                
                if (response.ok) {
                    log('applicationOutput', '‚úÖ SUCCESS! Application saved to MongoDB:\n' + JSON.stringify(data, null, 2));
                    alert('‚úÖ Application submitted successfully!\n\nCheck MongoDB Atlas to see it stored.');
                } else {
                    log('applicationOutput', '‚ùå ERROR:\n' + JSON.stringify(data, null, 2), true);
                }
            } catch (error) {
                log('applicationOutput', '‚ùå ERROR: ' + error.message, true);
            }
        }

        async function testGetApplications() {
            if (!token) {
                log('getApplicationsOutput', '‚ùå ERROR: Please login first!', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/applications`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    log('getApplicationsOutput', `‚úÖ SUCCESS! Found ${data.count} applications:\n` + JSON.stringify(data, null, 2));
                } else {
                    log('getApplicationsOutput', '‚ùå ERROR:\n' + JSON.stringify(data, null, 2), true);
                }
            } catch (error) {
                log('getApplicationsOutput', '‚ùå ERROR: ' + error.message, true);
            }
        }

        async function checkMongoDB() {
            try {
                const response = await fetch('http://localhost:5000/api/test-db');
                const data = await response.json();
                
                if (response.ok) {
                    log('mongoOutput', '‚úÖ MongoDB Status:\n' + JSON.stringify(data, null, 2));
                } else {
                    log('mongoOutput', '‚ùå ERROR:\n' + JSON.stringify(data, null, 2), true);
                }
            } catch (error) {
                log('mongoOutput', '‚ùå ERROR: ' + error.message, true);
            }
        }

        // Test connection on page load
        window.onload = () => {
            testBackend();
        };
    </script>
</body>
</html>
